<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weekly Job Calendar</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: auto;
    padding: 20px;
  }
  h1, h2, h3 {
    color: #333;
  }
  label {
    display: block;
    margin-top: 10px;
  }
  input[type="text"], input[type="date"], input[type="number"] {
    width: 100%;
    padding: 6px;
    margin-top: 4px;
    box-sizing: border-box;
  }
  button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
  .job-item {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    background-color: #f9f9f9;
  }
  .job-item button {
    background-color: #e74c3c;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
  }
</style>
</head>
<body>
  <h1>Weekly Job Calendar</h1>

  <section>
    <label for="job-date">Date</label>
    <input type="date" id="job-date" required />

    <label for="customer">Customer</label>
    <input type="text" id="customer" placeholder="Customer name" required />

    <label for="address">Address</label>
    <input type="text" id="address" placeholder="Job address" required />

    <label for="phone">Phone</label>
    <input type="text" id="phone" placeholder="Phone number" />

    <label for="reason">Reason</label>
    <input type="text" id="reason" placeholder="Job reason (default: Call out charge)" />

    <label for="price">Price (£)</label>
    <input type="number" id="price" step="0.01" placeholder="Price" />

    <button id="add-job-btn">Add Job</button>
  </section>

  <h2>Scheduled Jobs</h2>
  <div id="jobs-list">Loading jobs...</div>

<script>
  // Helper: fetch bookings grouped by date_key
  async function fetchBookings() {
    const res = await fetch('/.netlify/functions/bookings');
    if (!res.ok) {
      alert('Failed to fetch bookings');
      return {};
    }
    return await res.json();
  }

  // Create a job HTML element with a delete button
  function createJobElement(job, dateKey) {
    const div = document.createElement('div');
    div.className = 'job-item';

    div.innerHTML = `
      <strong>Customer:</strong> ${job.customer}<br/>
      <strong>Address:</strong> ${job.address}<br/>
      <strong>Phone:</strong> ${job.phone || '-'}<br/>
      <strong>Reason:</strong> ${job.reason || 'Call out charge'}<br/>
      <strong>Price:</strong> £${parseFloat(job.price || 0).toFixed(2)}<br/>
      <button class="delete-btn">Delete</button>
    `;

    div.querySelector('.delete-btn').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this job?')) return;

      const response = await fetch('/.netlify/functions/bookings', {
        method: 'POST',
        body: JSON.stringify({
          type: 'delete',
          date_key: dateKey,
          jobId: job.id,
        }),
      });

      if (response.ok) {
        loadJobs();
      } else {
        alert('Failed to delete job');
      }
    });

    return div;
  }

  // Load all jobs and render grouped by date
  async function loadJobs() {
    const jobsList = document.getElementById('jobs-list');
    jobsList.textContent = 'Loading jobs...';

    const bookings = await fetchBookings();

    jobsList.innerHTML = '';

    if (!bookings || Object.keys(bookings).length === 0) {
      jobsList.textContent = 'No jobs scheduled.';
      return;
    }

    for (const [dateKey, jobs] of Object.entries(bookings)) {
      const dateHeader = document.createElement('h3');
      dateHeader.textContent = `Date: ${dateKey}`;
      jobsList.appendChild(dateHeader);

      jobs.forEach(job => {
        jobsList.appendChild(createJobElement(job, dateKey));
      });
    }
  }

  // Add a new job from the form
  async function addJob() {
    const dateInput = document.getElementById('job-date').value;
    if (!dateInput) {
      alert('Please select a date');
      return;
    }

    const customer = document.getElementById('customer').value.trim();
    if (!customer) {
      alert('Please enter customer name');
      return;
    }

    const address = document.getElementById('address').value.trim();
    if (!address) {
      alert('Please enter address');
      return;
    }

    const phone = document.getElementById('phone').value.trim();
    const reason = document.getElementById('reason').value.trim() || 'Call out charge';
    const priceRaw = document.getElementById('price').value.trim();
    const price = priceRaw ? parseFloat(priceRaw).toFixed(2) : '0.00';

    // Create a new job object with unique ID
    const newJob = {
      id: crypto.randomUUID(),
      customer,
      address,
      phone,
      reason,
      price,
      timestamp: new Date().toISOString(),
    };

    const res = await fetch('/.netlify/functions/bookings', {
      method: 'POST',
      body: JSON.stringify({
        type: 'add',
        date_key: dateInput,
        job: newJob,
      }),
    });

    if (res.ok) {
      // Clear input fields
      document.getElementById('job-date').value = '';
      document.getElementById('customer').value = '';
      document.getElementById('address').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('reason').value = '';
      document.getElementById('price').value = '';

      loadJobs();
    } else {
      alert('Failed to add job');
    }
  }

  document.getElementById('add-job-btn').addEventListener('click', addJob);

  // Load jobs when page loads
  loadJobs();
</script>
</body>
</html>
