<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weekly Job Calendar</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #8e2de2, #4a00e0, #c77d87);
      color: white;
    }
    .container {
      max-width: 1200px;
      margin: 15px auto;
      padding: 10px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.95);
      color: black;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 100%;
    }
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .logo img {
      height: 50px;
      border-radius: 6px;
    }
    .earnings {
      background: #e74c3c;
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 1.1em;
      text-align: center;
    }
    .earnings span {
      font-weight: bold;
      color: #ffcc00;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .controls button {
      padding: 8px 16px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      font-size: 0.9em;
    }
    #global-search {
      width: 70%;
      max-width: 400px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.95em;
    }
    /* New Job Form */
    .new-booking {
      background: white;
      color: black;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 300px;
    }
    .new-booking h2 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      border-bottom: 1px solid #ddd;
    }
    .new-booking label {
      display: block;
      margin: 6px 0 3px;
      font-size: 0.9em;
      font-weight: 600;
    }
    .new-booking input,
    .new-booking textarea,
    .new-booking select {
      width: 100%;
      padding: 6px;
      margin-bottom: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .new-booking button {
      margin-top: 10px;
      padding: 10px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      width: 100%;
      font-size: 1em;
    }
    /* Weekly Schedule */
    .weekly-schedule {
      background: white;
      color: black;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 300px;
    }
    .weekly-schedule h2 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      border-bottom: 1px solid #ddd;
    }
    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .day {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 0.85em;
    }
    .day-name {
      font-weight: bold;
      color: #333;
    }
    .day-date {
      color: #007bff;
      font-size: 0.95em;
    }
    .job-list {
      margin-top: 5px;
    }
    .job-item {
      margin: 4px 0;
      padding: 4px;
      background: #f1f1f1;
      border-left: 3px solid #007bff;
      border-radius: 3px;
      font-size: 0.8em;
    }
    .job-customer {
      font-weight: bold;
    }
    .job-price {
      color: #000;
    }
    .job-status {
      font-size: 0.7em;
      padding: 1px 4px;
      border-radius: 3px;
    }
    .status-paid { background: #28a745; color: white; }
    .status-partial { background: #ffc107; color: black; }
    .status-unpaid { background: #dc3545; color: white; }

    /* Compact Edit Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      width: 90%;
      max-width: 360px;
      border-radius: 10px;
      padding: 12px;
      font-size: 0.9em;
      color: black;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid #eee;
    }
    .modal-header h3 {
      font-size: 1.1em;
      margin: 0;
    }
    .close-modal {
      font-size: 1.3em;
      color: #aaa;
      cursor: pointer;
    }
    .modal-body p {
      margin: 3px 0;
      font-size: 0.9em;
    }
    .modal-body hr {
      margin: 8px 0;
      border: 1px solid #eee;
    }
    .modal-body h4 {
      margin: 8px 0 4px 0;
      font-size: 0.95em;
    }
    .payment-list {
      max-height: 80px;
      overflow-y: auto;
      margin: 4px 0;
      font-size: 0.8em;
    }
    .payment-item {
      padding: 3px;
      background: #f8f9fa;
      border-radius: 2px;
    }
    .form-group {
      margin: 6px 0;
    }
    .form-group label {
      font-size: 0.85em;
      font-weight: 600;
    }
    .form-group input {
      padding: 4px;
      font-size: 0.9em;
    }
    .btn-add-payment,
    .btn-paid-full {
      padding: 6px 10px;
      font-size: 0.85em;
      margin: 4px 0;
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    .btn-paid-full {
      background: #28a745;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }
    .modal-footer button {
      padding: 6px 10px;
      font-size: 0.85em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-print { background: #6f42c1; color: white; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-cancel { background: #6c757d; color: white; }

    /* Print Receipt */
    @media print {
      body * { visibility: hidden; }
      #receipt, #receipt * { visibility: visible; color: #000; }
      #receipt {
        position: absolute;
        left: 0; top: 0;
        width: 210mm;
        padding: 12mm;
        box-sizing: border-box;
        font-size: 12px;
      }
      .no-print { display: none; }
      @page { margin: 0; size: A4; }
    }
    #receipt { display: none; }

    /* Password Screen */
    #password-screen {
      display: flex;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 2000;
      padding: 20px;
    }
    #password-screen input {
      padding: 10px;
      width: 80%;
      max-width: 300px;
      border: none;
      border-radius: 6px;
      margin: 8px 0;
      font-size: 1em;
    }
    #password-screen button {
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .new-booking, .weekly-schedule { width: 100%; }
      .days-grid { grid-template-columns: 1fr; }
      .modal-content { max-width: 90%; }
    }
  </style>
</head>
<body>

  <!-- Password Screen -->
  <div id="password-screen">
    <h2>🔒 Job Calendar</h2>
    <p id="setup-prompt">Set a password to secure your calendar.</p>
    <input type="password" id="password-input" placeholder="Enter password" />
    <input type="password" id="password-confirm" placeholder="Confirm password" style="display:none;" />
    <button onclick="window.checkPassword()">Unlock</button>
  </div>

  <!-- Main App -->
  <div id="main-app" class="no-print" style="display:none;">
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <div class="logo">
            <img src="https://acaciatv.netlify.app/assets/images/logo.svg" alt="Logo" />
          </div>
          <div style="flex:1; min-width:200px;">
            <div class="earnings">Earnings: <span id="total-earnings">£0.00</span></div>
            <input type="text" id="global-search" placeholder="🔍 Search..." />
            <div class="controls">
              <button onclick="prevWeek()">◀ Prev</button>
              <span id="current-week-range" style="font-size:0.9em;">28 Jul - 03 Aug</span>
              <button onclick="nextWeek()">Next ▶</button>
            </div>
          </div>
        </div>
      </div>

      <!-- New Job -->
      <div class="new-booking">
        <h2>New Job</h2>
        <form id="booking-form">
          <label>Date</label>
          <input type="date" id="job-date" required />
          <label>Name</label>
          <input type="text" id="customer-name" required />
          <label>Address</label>
          <textarea id="address" placeholder="Optional"></textarea>
          <label>Phone</label>
          <input type="tel" id="phone" />
          <label>Reason</label>
          <textarea id="reason" placeholder="Call out"></textarea>
          <label>Price (£)</label>
          <input type="number" step="0.01" id="price" required />
          <label>Assign</label>
          <select id="assigned" required>
            <option value="">-- Tech --</option>
            <option value="Stephen">Stephen</option>
            <option value="Darren">Darren</option>
          </select>
          <button type="submit">Add Job</button>
        </form>
      </div>

      <!-- Schedule -->
      <div class="weekly-schedule">
        <h2>Schedule</h2>
        <div class="days-grid" id="days-grid"></div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Job: <span id="modal-customer"></span></h3>
          <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <p><strong>Date:</strong> <span id="modal-date"></span></p>
          <p><strong>Total:</strong> £<span id="modal-total">0.00</span></p>
          <p><strong>Paid:</strong> £<span id="modal-paid">0.00</span></p>
          <p><strong>Due:</strong> £<span id="modal-outstanding">0.00</span></p>
          <p><strong>Assigned:</strong> <span id="modal-assigned"></span></p>
          <p><strong>Invoice:</strong> <span id="modal-invoice">10001</span></p>
          <hr>
          <h4>Payments</h4>
          <div class="payment-list" id="payment-list"></div>
          <div class="form-group">
            <label>Add Payment (£)</label>
            <input type="number" id="new-payment" step="0.01" placeholder="50.00" />
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="payment-date" />
          </div>
          <button class="btn-add-payment" onclick="addPayment()">Add</button>
          <button class="btn-paid-full" onclick="markPaidInFull()">Paid Full</button>
        </div>
        <div class="modal-footer">
          <button class="btn-print" onclick="printReceipt()">Print</button>
          <button class="btn-delete" onclick="deleteJob()">Delete</button>
          <button class="btn-cancel" onclick="closeModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Hidden Receipt -->
    <div id="receipt">
      <table width="100%" style="font-size:12px; color:#000;">
        <tr>
          <td width="30%"><img src="https://acaciatv.netlify.app/assets/images/logo.svg" height="50" /><br><strong>Acacia TV</strong><br>Filer Road, Halfway<br>Sheerness, Kent, ME12 3AL<br>01795 873160</td>
          <td width="70%" align="right">
            <h2>Invoice <span id="print-invoice">10001</span></h2>
            <strong>Date:</strong> <span id="print-date">26/03/2025</span><br>
            <strong>Due:</strong> <span id="print-due-date">26/03/2025</span>
          </td>
        </tr>
      </table>
      <h3>Billed To</h3>
      <strong><span id="print-customer">Name</span></strong><br>
      <span id="print-address">Address</span>
      <table width="100%" border="1" style="border-collapse:collapse; margin:15px 0;">
        <thead><tr style="background:#f0f0f0;"><th>Description</th><th>Qty</th><th>Price</th><th>Amount</th></tr></thead>
        <tbody><tr><td><span id="print-reason">Call out</span></td><td>1</td><td>£<span id="print-unit-price">0.00</span></td><td>£<span id="print-amount">0.00</span></td></tr></tbody>
        <tfoot><tr><td colspan="3" align="right"><strong>Total:</strong></td><td>£<span id="print-total">0.00</span></td></tr></tfoot>
      </table>
      <div id="print-paid-date"></div>
      <p><strong>Amount Due:</strong> £<span id="print-due">0.00</span></p>
    </div>
  </div>

  <script>
    const API_BASE = 'https://weekly-job-calendar.netlify.app/.netlify/functions/bookings';
    let currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + (currentWeekStart.getDay() === 0 ? -6 : 1));
    currentWeekStart.setHours(0,0,0,0);
    let editingJob = null;

    window.checkPassword = function() {
      const pwd = document.getElementById('password-input').value.trim();
      const confirm = document.getElementById('password-confirm').value.trim();
      const saved = localStorage.getItem('calendarPassword');
      if (!saved) {
        if (pwd.length < 4) return alert('Min 4 chars.');
        if (pwd !== confirm) return alert('No match.');
        localStorage.setItem('calendarPassword', btoa(pwd));
        if (!localStorage.getItem('nextInvoiceNumber')) localStorage.setItem('nextInvoiceNumber','10001');
        showMainApp();
      } else {
        if (btoa(pwd) === saved) showMainApp();
        else { alert('Wrong'); document.getElementById('password-input').value=''; }
      }
    };

    function showMainApp() {
      document.getElementById('password-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      loadBookingsAndRender();
    }

    async function loadBookingsAndRender() {
      try {
        const res = await fetch(API_BASE);
        const bookings = await res.json();
        renderWeek(bookings);
        updateEarnings(bookings);
      } catch { alert('No connection.'); }
    }

    async function addJobToDB(dateKey, job) {
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({type:'add', date_key:dateKey, job})
      });
      return res.ok;
    }

    function formatDate(date) {
      return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()}`;
    }
    function formatKey(date) {
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${y}-${m}-${d}`;
    }
    function parseDate(s) {
      const [y,m,d] = s.split('-').map(Number);
      return new Date(y, m-1, d);
    }

    function updateEarnings(bookings) {
      let total = 0;
      Object.keys(bookings).forEach(k => {
        bookings[k].forEach(j => {
          (j.payments || []).forEach(p => total += parseFloat(p.amount) || 0);
        });
      });
      document.getElementById('total-earnings').textContent = `£${total.toFixed(2)}`;
    }

    function renderWeek(bookings = {}) {
      const grid = document.getElementById('days-grid');
      grid.innerHTML = '';
      const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      let earnings = 0;

      days.forEach((name, i) => {
        const d = new Date(currentWeekStart);
        d.setDate(d.getDate() + i);
        const key = formatKey(d);
        const bookingsOnDay = bookings[key] || [];
        const totalPaid = bookingsOnDay.reduce((sum, j) => 
          sum + (j.payments || []).reduce((p, pay) => p + (parseFloat(pay.amount)||0), 0), 0);
        earnings += totalPaid;

        const el = document.createElement('div');
        el.className = 'day';
        el.innerHTML = `
          <div class="day-name">${name}</div>
          <div class="day-date">${formatDate(d)}</div>
          <div class="job-list">
            ${bookingsOnDay.length ? bookingsOnDay.map((j, idx) => {
              const paid = (j.payments || []).reduce((a,p) => a + (parseFloat(p.amount)||0), 0);
              const total = parseFloat(j.price) || 0;
              const status = paid >= total ? 'paid' : (paid > 0 ? 'partial' : 'unpaid');
              return `<div class="job-item job-${status}" onclick="event.stopPropagation();openEditModal('${key}',${idx})">
                <div class="job-customer">${j.customer}</div>
                <div class="job-price">£${paid.toFixed(2)}</div>
                <span class="job-status status-${status}">${status}</span>
              </div>`;
            }).join('') : '<div class="no-jobs">—</div>'}
          </div>
        `;
        el.onclick = () => bookingsOnDay.length === 1 && openEditModal(key, 0);
        grid.appendChild(el);
      });

      document.getElementById('total-earnings').textContent = `£${earnings.toFixed(2)}`;
      const end = new Date(currentWeekStart); end.setDate(end.getDate()+6);
      document.getElementById('current-week-range').textContent = `${formatDate(currentWeekStart)} - ${formatDate(end)}`;
      document.getElementById('job-date').value = formatKey(new Date());
    }

    function prevWeek() { currentWeekStart.setDate(currentWeekStart.getDate()-7); loadBookingsAndRender(); }
    function nextWeek() { currentWeekStart.setDate(currentWeekStart.getDate()+7); loadBookingsAndRender(); }

    async function openEditModal(dateKey, jobIndex) {
      try {
        const res = await fetch(API_BASE);
        const bookings = await res.json();
        const job = bookings[dateKey]?.[jobIndex];
        if (!job) return alert('Job missing.');
        editingJob = {dateKey, jobIndex};
        document.getElementById('modal-customer').textContent = job.customer;
        document.getElementById('modal-date').textContent = formatDate(parseDate(dateKey));
        document.getElementById('modal-total').textContent = parseFloat(job.price).toFixed(2);
        document.getElementById('modal-assigned').textContent = job.assigned;
        const paid = (job.payments || []).reduce((a,p) => a + (parseFloat(p.amount)||0), 0);
        document.getElementById('modal-paid').textContent = paid.toFixed(2);
        document.getElementById('modal-outstanding').textContent = Math.max(0, job.price - paid).toFixed(2);
        document.getElementById('modal-invoice').textContent = job.invoiceNumber || 'N/A';
        const list = document.getElementById('payment-list');
        list.innerHTML = job.payments?.length ? job.payments.map(p => 
          `<div class="payment-item">£${p.amount} on ${p.date}</div>`
        ).join('') : '<div class="payment-item">None</div>';
        document.getElementById('payment-date').value = formatKey(new Date());
        document.getElementById('edit-modal').style.display = 'flex';
      } catch { alert('Load failed.'); }
    }

    function closeModal() {
      document.getElementById('edit-modal').style.display = 'none';
      editingJob = null;
    }

    async function addPayment() {
      const amount = parseFloat(document.getElementById('new-payment').value);
      const date = document.getElementById('payment-date').value;
      if (!amount || amount <= 0) return alert('Valid amount.');
      if (!date) return alert('Pick date.');
      try {
        const res = await fetch(API_BASE);
        const bookings = await res.json();
        const job = bookings[editingJob.dateKey][editingJob.jobIndex];
        if (!job.payments) job.payments = [];
        job.payments.push({ amount: amount.toFixed(2), date });
        const success = await fetch(API_BASE, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({type:'update', date_key:editingJob.dateKey, jobIndex:editingJob.jobIndex, job})
        });
        if (success.ok) {
          document.getElementById('new-payment').value = '';
          openEditModal(editingJob.dateKey, editingJob.jobIndex);
        } else {
          alert('Save failed.');
        }
      } catch { alert('Network error.'); }
    }

    async function markPaidInFull() {
      try {
        const res = await fetch(API_BASE);
        const bookings = await res.json();
        const job = bookings[editingJob.dateKey][editingJob.jobIndex];
        const total = parseFloat(job.price);
        const paid = (job.payments || []).reduce((a,p) => a + (parseFloat(p.amount)||0), 0);
        if (paid >= total) return alert('Already paid.');
        if (!job.payments) job.payments = [];
        job.payments.push({ amount: (total - paid).toFixed(2), date: formatKey(new Date()) });
        const success = await fetch(API_BASE, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({type:'update', date_key:editingJob.dateKey, jobIndex:editingJob.jobIndex, job})
        });
        if (success.ok) {
          openEditModal(editingJob.dateKey, editingJob.jobIndex);
          alert('Paid in full!');
        }
      } catch { alert('Update failed.'); }
    }

    async function deleteJob() {
      if (!confirm('Delete job?')) return;
      const success = await fetch(API_BASE, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({type:'delete', date_key:editingJob.dateKey, jobIndex:editingJob.jobIndex})
      });
      if (success.ok) {
        closeModal();
        loadBookingsAndRender();
      } else {
        alert('Delete failed.');
      }
    }

    document.getElementById('booking-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const jobDateStr = document.getElementById('job-date').value;
      const customer = document.getElementById('customer-name').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const assigned = document.getElementById('assigned').value;
      if (!customer || !assigned || !jobDateStr || !price || price <= 0) return alert('Fill valid data.');

      const jobDate = parseDate(jobDateStr);
      const dayKey = formatKey(jobDate);
      const newJob = {
        customer,
        address: document.getElementById('address').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        reason: document.getElementById('reason').value.trim() || 'Call out',
        price: price.toFixed(2),
        assigned,
        payments: [],
        invoiceNumber: (parseInt(localStorage.getItem('nextInvoiceNumber')||'10001') + 1).toString(),
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('nextInvoiceNumber', newJob.invoiceNumber);

      const success = await addJobToDB(dayKey, newJob);
      if (success) {
        this.reset();
        document.getElementById('job-date').value = formatKey(new Date());
        alert('Job added!');
        currentWeekStart = new Date(jobDate);
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + (currentWeekStart.getDay() === 0 ? -6 : 1));
        loadBookingsAndRender();
      } else {
        alert('Add failed.');
      }
    });

    // Search
    document.getElementById('global-search').addEventListener('input', function() {
      const q = this.value.trim().toLowerCase();
      document.getElementById('search-results').style.display = q ? 'block' : 'none';
    });

    // Print Fix for Galaxy A21s
    function printReceipt() {
      if (!editingJob) return;
      fetch(API_BASE).then(r => r.json()).then(bookings => {
        const job = bookings[editingJob.dateKey]?.[editingJob.jobIndex];
        if (!job) return alert('Not found.');
        const dateStr = formatDate(parseDate(editingJob.dateKey));
        document.getElementById('print-invoice').textContent = job.invoiceNumber || 'N/A';
        document.getElementById('print-date').textContent = dateStr;
        document.getElementById('print-due-date').textContent = dateStr;
        document.getElementById('print-customer').textContent = job.customer;
        document.getElementById('print-address').innerHTML = (job.address || 'N/A').replace(/\n/g, '<br>');
        document.getElementById('print-reason').textContent = job.reason || 'Call out';
        const price = job.price;
        document.getElementById('print-unit-price').textContent = price;
        document.getElementById('print-amount').textContent = price;
        document.getElementById('print-total').textContent = price;
        const paid = (job.payments || []).reduce((a,p) => a + (parseFloat(p.amount)||0), 0);
        const due = Math.max(0, price - paid).toFixed(2);
        document.getElementById('print-paid-date').innerHTML = paid ? `<p><strong>Paid:</strong> £${paid.toFixed(2)}</p>` : '';
        document.getElementById('print-due').textContent = due;
        const receipt = document.getElementById('receipt');
        receipt.style.position = 'absolute';
        receipt.style.left = '-9999px';
        receipt.style.top = '-9999px';
        receipt.style.display = 'block';
        setTimeout(() => {
          window.print();
          setTimeout(() => receipt.style.display = 'none', 500);
        }, 300);
      }).catch(() => alert('Failed to load job data.'));
    }

    window.onload = function() {
      const saved = localStorage.getItem('calendarPassword');
      document.getElementById('password-confirm').style.display = saved ? 'none' : 'block';
      document.getElementById('setup-prompt').textContent = saved ? 'Enter password' : 'Set new password';
      document.getElementById('password-screen').style.display = 'flex';
    };
  </script>
</body>
</html>
